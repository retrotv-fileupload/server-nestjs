<!doctype html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ì²­í¬ ê¸°ë°˜ ëŒ€ìš©ëŸ‰ íŒŒì¼ ì—…ë¡œë“œ</title>
        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }

            .container {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            h1 {
                color: #333;
                text-align: center;
                margin-bottom: 30px;
            }

            .upload-section {
                margin-bottom: 30px;
            }

            .file-input {
                width: 100%;
                padding: 10px;
                border: 2px dashed #ddd;
                border-radius: 8px;
                text-align: center;
                margin-bottom: 20px;
                cursor: pointer;
                transition: border-color 0.3s;
            }

            .file-input:hover {
                border-color: #4caf50;
            }

            input[type="file"] {
                width: 100%;
                padding: 10px;
                margin-bottom: 10px;
            }

            .controls {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }

            button {
                padding: 12px 24px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                transition: background-color 0.3s;
            }

            .btn-primary {
                background-color: #4caf50;
                color: white;
            }

            .btn-primary:hover {
                background-color: #45a049;
            }

            .btn-secondary {
                background-color: #f44336;
                color: white;
            }

            .btn-secondary:hover {
                background-color: #da190b;
            }

            .btn-disabled {
                background-color: #cccccc;
                color: #666;
                cursor: not-allowed;
            }

            .progress-container {
                margin-bottom: 20px;
            }

            .progress-bar {
                width: 100%;
                height: 25px;
                background-color: #f0f0f0;
                border-radius: 12px;
                overflow: hidden;
                margin-bottom: 10px;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #4caf50 0%, #45a049 100%);
                width: 0%;
                transition: width 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
            }

            .status {
                padding: 15px;
                margin-bottom: 20px;
                border-radius: 6px;
                background-color: #e7f3ff;
                border-left: 4px solid #2196f3;
            }

            .status.success {
                background-color: #e8f5e8;
                border-left-color: #4caf50;
            }

            .status.error {
                background-color: #ffebee;
                border-left-color: #f44336;
            }

            .chunk-info {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
                margin-top: 10px;
            }

            .info-item {
                background: #f8f9fa;
                padding: 10px;
                border-radius: 4px;
                text-align: center;
            }

            .info-label {
                font-size: 12px;
                color: #666;
                margin-bottom: 5px;
            }

            .info-value {
                font-size: 16px;
                font-weight: bold;
                color: #333;
            }

            .log {
                background: #1e1e1e;
                color: #00ff00;
                font-family: "Courier New", monospace;
                padding: 15px;
                border-radius: 6px;
                height: 200px;
                overflow-y: auto;
                font-size: 12px;
                line-height: 1.4;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸš€ ì²­í¬ ê¸°ë°˜ ëŒ€ìš©ëŸ‰ íŒŒì¼ ì—…ë¡œë“œ</h1>

            <div class="upload-section">
                <div class="file-input">
                    <input type="file" id="fileInput" />
                </div>

                <div class="controls">
                    <button id="uploadBtn" class="btn-primary" onclick="startUpload()">ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘</button>
                    <button id="cancelBtn" class="btn-secondary btn-disabled" onclick="cancelUpload()">
                        âŒ ì—…ë¡œë“œ ì·¨ì†Œ
                    </button>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill">0%</div>
                </div>

                <div class="chunk-info">
                    <div class="info-item">
                        <div class="info-label">ì§„í–‰ë¥ </div>
                        <div id="progressText" class="info-value">0%</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì—…ë¡œë“œëœ ì²­í¬</div>
                        <div id="chunksText" class="info-value">0 / 0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">íŒŒì¼ í¬ê¸°</div>
                        <div id="fileSizeText" class="info-value">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ìƒíƒœ</div>
                        <div id="statusText" class="info-value">ëŒ€ê¸°ì¤‘</div>
                    </div>
                </div>
            </div>

            <div id="status" class="status">íŒŒì¼ì„ ì„ íƒí•˜ê³  ì—…ë¡œë“œ ì‹œì‘ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>

            <div class="log" id="log"></div>
        </div>

        <script>
            let sessionId = null;
            let statusInterval = null;
            let isUploading = false;

            const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB ì²­í¬ í¬ê¸°
            const API_BASE = "http://localhost:3000";

            // ë¡œê·¸ í•¨ìˆ˜
            function log(message, type = "info") {
                const logElement = document.getElementById("log");
                const timestamp = new Date().toLocaleTimeString();
                const prefix = type === "error" ? "âŒ" : type === "success" ? "âœ…" : "â„¹ï¸";

                logElement.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
                logElement.scrollTop = logElement.scrollHeight;
                console.log(`[${type.toUpperCase()}]`, message);
            }

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            function updateStatus(message, type = "info") {
                const statusElement = document.getElementById("status");
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
                log(message, type);
            }

            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            function updateProgress(progress, uploaded, total) {
                document.getElementById("progressFill").style.width = progress + "%";
                document.getElementById("progressFill").textContent = progress + "%";
                document.getElementById("progressText").textContent = progress + "%";
                document.getElementById("chunksText").textContent = `${uploaded} / ${total}`;
            }

            // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
            function formatFileSize(bytes) {
                if (bytes === 0) return "0 Bytes";
                const k = 1024;
                const sizes = ["Bytes", "KB", "MB", "GB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
            }

            // ë²„íŠ¼ ìƒíƒœ ê´€ë¦¬
            function setButtonStates(uploading) {
                const uploadBtn = document.getElementById("uploadBtn");
                const cancelBtn = document.getElementById("cancelBtn");

                if (uploading) {
                    uploadBtn.className = "btn-primary btn-disabled";
                    uploadBtn.textContent = "â³ ì—…ë¡œë“œ ì¤‘...";
                    cancelBtn.className = "btn-secondary";
                } else {
                    uploadBtn.className = "btn-primary";
                    uploadBtn.textContent = "ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘";
                    cancelBtn.className = "btn-secondary btn-disabled";
                }
            }

            // ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
            function startStatusMonitoring() {
                if (statusInterval) clearInterval(statusInterval);

                statusInterval = setInterval(async () => {
                    if (!sessionId) return;

                    try {
                        const response = await fetch(`${API_BASE}/api/files/upload/status?sessionId=${sessionId}`);
                        const data = await response.json();

                        if (response.ok) {
                            updateProgress(data.progress, data.uploadedChunks, data.totalChunks);
                            document.getElementById("statusText").textContent = data.status;

                            if (data.progress === 100 && data.status === "all_chunks_uploaded") {
                                log("ëª¨ë“  ì²­í¬ ì—…ë¡œë“œ ì™„ë£Œ! íŒŒì¼ ë³‘í•©ì„ ì‹œì‘í•©ë‹ˆë‹¤.", "success");
                            }
                        }
                    } catch (error) {
                        log(`ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, "error");
                    }
                }, 1000); // 1ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
            }

            // ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
            function stopStatusMonitoring() {
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
            }

            // ì—…ë¡œë“œ ì‹œì‘
            async function startUpload() {
                const fileInput = document.getElementById("fileInput");
                const file = fileInput.files[0];

                if (!file) {
                    updateStatus("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
                    return;
                }

                if (isUploading) {
                    updateStatus("ì´ë¯¸ ì—…ë¡œë“œê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.", "error");
                    return;
                }

                isUploading = true;
                setButtonStates(true);

                // íŒŒì¼ ì •ë³´ í‘œì‹œ
                document.getElementById("fileSizeText").textContent = formatFileSize(file.size);
                document.getElementById("statusText").textContent = "ì´ˆê¸°í™” ì¤‘";

                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

                log(`ì—…ë¡œë“œ ì‹œì‘: ${file.name} (${formatFileSize(file.size)}, ${totalChunks}ê°œ ì²­í¬)`);

                try {
                    // 1. ì—…ë¡œë“œ ì´ˆê¸°í™”
                    updateStatus("ì—…ë¡œë“œ ì„¸ì…˜ì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘...");

                    const initResponse = await fetch(`${API_BASE}/api/files/upload/init`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            fileName: file.name,
                            fileSize: file.size,
                            totalChunks: totalChunks,
                            mimeType: file.type,
                        }),
                    });

                    const initData = await initResponse.json();

                    if (!initResponse.ok) {
                        throw new Error(initData.error || "ì´ˆê¸°í™” ì‹¤íŒ¨");
                    }

                    sessionId = initData.sessionId;
                    log(`ì„¸ì…˜ ìƒì„± ì™„ë£Œ: ${sessionId}`);

                    // 2. ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
                    startStatusMonitoring();

                    // 3. ì²­í¬ ì—…ë¡œë“œ
                    updateStatus("íŒŒì¼ì„ ì²­í¬ ë‹¨ìœ„ë¡œ ì—…ë¡œë“œí•˜ëŠ” ì¤‘...");

                    for (let i = 0; i < totalChunks; i++) {
                        if (!isUploading) break; // ì·¨ì†Œëœ ê²½ìš°

                        const start = i * CHUNK_SIZE;
                        const end = Math.min(start + CHUNK_SIZE, file.size);
                        const chunk = file.slice(start, end);

                        const formData = new FormData();
                        formData.append("sessionId", sessionId);
                        formData.append("chunkIndex", i);
                        formData.append("chunk", chunk);

                        let retryCount = 0;
                        const maxRetries = 3;

                        while (retryCount <= maxRetries) {
                            try {
                                const response = await fetch(`${API_BASE}/api/files/upload/chunk`, {
                                    method: "POST",
                                    body: formData,
                                });

                                const result = await response.json();

                                if (!response.ok) {
                                    throw new Error(result.error || "ì²­í¬ ì—…ë¡œë“œ ì‹¤íŒ¨");
                                }

                                log(`ì²­í¬ ${i + 1}/${totalChunks} ì—…ë¡œë“œ ì™„ë£Œ (${result.progress}%)`);

                                // ì¦‰ì‹œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                                updateProgress(result.progress, result.uploadedChunks, result.totalChunks);

                                // ëª¨ë“  ì²­í¬ê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
                                if (result.isComplete) {
                                    log("ğŸ‰ ëª¨ë“  ì²­í¬ ì—…ë¡œë“œ ì™„ë£Œ!", "success");
                                    updateStatus("ëª¨ë“  ì²­í¬ ì—…ë¡œë“œ ì™„ë£Œ! íŒŒì¼ ë³‘í•© ì¤€ë¹„ ì¤‘...", "success");
                                }

                                break;
                            } catch (error) {
                                retryCount++;
                                if (retryCount > maxRetries) {
                                    throw new Error(
                                        `ì²­í¬ ${i} ì—…ë¡œë“œ ì‹¤íŒ¨ (ì¬ì‹œë„ ${maxRetries}íšŒ ì‹¤íŒ¨): ${error.message}`,
                                    );
                                }
                                log(
                                    `ì²­í¬ ${i} ì—…ë¡œë“œ ì‹¤íŒ¨, ì¬ì‹œë„ ${retryCount}/${maxRetries}... ì—ëŸ¬: ${error.message}`,
                                    "error",
                                );

                                // ì‘ë‹µ ìƒíƒœ ì½”ë“œì™€ ë³¸ë¬¸ì„ ë¡œê·¸ë¡œ ì¶œë ¥
                                if (error.response) {
                                    log(`ì‘ë‹µ ìƒíƒœ: ${error.response.status}`, "error");
                                    log(`ì‘ë‹µ ë³¸ë¬¸: ${await error.response.text()}`, "error");
                                }

                                await new Promise(resolve => setTimeout(resolve, 1000)); // 1ì´ˆ ëŒ€ê¸°
                            }
                        }
                    }

                    if (!isUploading) {
                        updateStatus("ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", "error");
                        return;
                    }

                    // ì§§ì€ ëŒ€ê¸° ì‹œê°„ ì¶”ê°€í•˜ì—¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§ì´ ë§ˆì§€ë§‰ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•¨
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // 4. ì—…ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬
                    updateStatus("íŒŒì¼ ë³‘í•© ì¤‘...");
                    log("ëª¨ë“  ì²­í¬ ì—…ë¡œë“œ ì™„ë£Œ, íŒŒì¼ ë³‘í•©ì„ ì‹œì‘í•©ë‹ˆë‹¤...");

                    const completeResponse = await fetch(`${API_BASE}/api/files/upload/complete`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ sessionId }),
                    });

                    const completeData = await completeResponse.json();

                    if (!completeResponse.ok) {
                        throw new Error(completeData.error || "ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨");
                    }

                    updateStatus(`ì—…ë¡œë“œ ì™„ë£Œ! íŒŒì¼ ID: ${completeData.file.id}`, "success");
                    log(`âœ… ì—…ë¡œë“œ ì„±ê³µ: ${completeData.file.downloadUrl}`, "success");
                } catch (error) {
                    updateStatus(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, "error");
                    log(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, "error");
                } finally {
                    isUploading = false;
                    setButtonStates(false);
                    stopStatusMonitoring();
                    sessionId = null;
                }
            }

            // ì—…ë¡œë“œ ì·¨ì†Œ
            async function cancelUpload() {
                if (!isUploading || !sessionId) {
                    updateStatus("ì·¨ì†Œí•  ì—…ë¡œë“œê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/files/upload/cancel`, {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ sessionId }),
                    });

                    if (response.ok) {
                        updateStatus("ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
                        log("ì—…ë¡œë“œ ì·¨ì†Œë¨", "success");
                    }
                } catch (error) {
                    log(`ì·¨ì†Œ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, "error");
                } finally {
                    isUploading = false;
                    setButtonStates(false);
                    stopStatusMonitoring();
                    sessionId = null;
                    updateProgress(0, 0, 0);
                    document.getElementById("statusText").textContent = "ì·¨ì†Œë¨";
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
            document.addEventListener("DOMContentLoaded", () => {
                log("ì²­í¬ ê¸°ë°˜ ì—…ë¡œë“œ í´ë¼ì´ì–¸íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.");
                log(`ì²­í¬ í¬ê¸°: ${formatFileSize(CHUNK_SIZE)}`);
                log(`API ì„œë²„: ${API_BASE}`);
            });

            // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
            window.addEventListener("beforeunload", e => {
                if (isUploading) {
                    e.preventDefault();
                    e.returnValue = "ì—…ë¡œë“œê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                }
            });
        </script>
    </body>
</html>
